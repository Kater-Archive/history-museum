{"cacheTime": 1595094728, "baseUrl": "https://kater.me/d/63779", "title": "用 php 產生 png 圖片：近 x 個上線使用者", "content": [{"author": "500 Internal Server Error", "body": "\n<p>\n 這篇只是一個紀錄（或是心得）。\n <br/>\n<br/>\n 以最近做的「近 x 個上線使用者」為例。\n </p>\n<hr/>\n<hr/>\n<hr/>\n<p>\n<img alt=\"\" src=\"http://ls197.000webhostapp.com/kater/lastSeen5.png\" title=\"\"/>\n</p>\n<h3>\n 前言\n </h3>\n<p>\n 基本架構來自於以前寫的一個破專案\n <a href=\"https://github.com/LianSheng197/php-png\" rel=\"nofollow noreferrer\" target=\"_blank\">\n php-png\n </a>\n</p>\n<h3>\n 產生圖片\n </h3>\n<p>\n<strong>\n 幾個關鍵函式\n </strong>\n</p>\n<ul>\n<li>\n 建立圖片物件：ImageCreate()\n </li>\n<li>\n 指定背景顏色：ImageColorAllocate()\n </li>\n<li>\n 插入文字：ImageTTFText()\n </li>\n<li>\n 產生圖片：ImagePng()\n </li>\n<li>\n 銷毀圖片：ImageDestroy()\n </li>\n</ul>\n<p>\n 為了減少伺服器壓力，因此產生圖片時是一次產生，逐行處理\n <br/>\n （沒有二次疊加圖片。雖然我明白那樣才是解決排版的最簡易解法）\n </p>\n<p>\n 基於逐行處理，因此在內文的排版時就必須計算關鍵內容的寬度，並填入對應的空格。\n <br/>\n<br/>\n 這裡我採用的是直接計算有幾個非 ASCII 文字跟幾個 ASCII 文字，前者直接當作全形文字，給兩格寬度；後者則當半形文字，給一格寬度。\n <br/>\n<br/>\n （然而這只能應付 87% 的文字）\n <br/>\n （遇到編碼超過 0xFFFF 就會亂碼）\n <br/>\n （遇到字形檔不支援的字就會變方框，佔 ⅔ 格）\n <br/>\n （遇到 RLM 之類的零寬控制字元時就會大崩壞）\n </p>\n<p>\n 總之，在一大堆問題下，我選擇了無視ww\n </p>\n<h3>\n 架構\n </h3>\n<p>\n 從伺服器取得資料 &gt; 用 GAS 做中間媒介 &gt; 再由 php 產生圖片。\n </p>\n<p>\n 會選擇加上中間的 GAS 純粹是為了方便修改。\n <br/>\n 因為修改 GAS 比修改產生圖片那邊還要容易。\n <br/>\n （如果不是在家的話，每次要修改都要從 host 把它複製下來，改完再推上去，很麻煩。）\n <br/>\n （而 GAS 只要登入帳號就能改了）\n </p>\n<h3>\n 核心原始碼\n </h3>\n<p>\n<strong>\n GAS\n </strong>\n</p>\n<pre data-hljs=\"\"><code class=\"language-js\">// code.gs\nfunction doGet(e) {\nif(e.parameter.lastSeen != undefined) {\n // API: 取得最近 X 個上線\n let limit = e.parameter.lastSeen;\n let rawData = UrlFetchApp.fetch(\"https://kater.me/api/users?sort=-lastSeenAt&amp;page[limit]=\" + limit, opt).getContentText();\n let users = JSON.parse(rawData);\n \n let data = { data: [] };\n let final = {};\n users.data.forEach(function(user) {\n let temp = {};\n temp.id = user.id;\n \n if(temp.id == FETCH_DATA_UID){\n temp.id = \"0\";\n temp.username = \"\";\n temp.time = (Date.parse(user.attributes.lastSeenAt) / 1000) - 292563 + 32;\n final = temp;\n return;\n } else {\n temp.username = user.attributes.username;\n if(user.attributes.lastSeenAt != undefined){\n temp.time = (Date.parse(user.attributes.lastSeenAt) / 1000) + 29;\n } else {\n temp.time = \"X\";\n }\n }\n \n data.data.push(temp);\n });\n \n data.data.push(final);\n return ContentService.createTextOutput(JSON.stringify(data));\n }\n}</code></pre>\n<script>\n if(\"undefined\"!==typeof hljs)hljs._ha();else if(\"undefined\"===typeof hljsLoading){hljsLoading=1;var a=document.getElementsByTagName(\"head\")[0],e=document.createElement(\"link\");e.type=\"text/css\";e.rel=\"stylesheet\";e.href=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css\";a.appendChild(e);e=document.createElement(\"script\");e.type=\"text/javascript\";e.onload=function(){var d={},f=0;hljs._hb=function(b){b.removeAttribute(\"data-hljs\");var c=b.innerHTML;c in d?b.innerHTML=d[c]:(7<++f&&(d={},f=0),hljs.highlightBlock(b.firstChild),d[c]=b.innerHTML)};hljs._ha=function(){for(var b=document.querySelectorAll(\"pre[data-hljs]\"),c=b.length;0<c;)hljs._hb(b.item(--c))};hljs._ha()};e.async=!0;e.src=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js\";a.appendChild(e)}\n </script>\n<p>\n<strong>\n PHP (2020.05.08)\n </strong>\n</p>\n<pre data-hljs=\"\"><code class=\"language-php\">// lastSeen.php\n$dt = new DateTime();\n$dateTime = $dt-&gt;format('Y-m-d H:i:s');\n$now = time();\n\n$dnt_open = getDNT();\n$ref = getRef();\n\nif (isset($_GET[\"limit\"])) {\n $limit = $_GET[\"limit\"];\n} else {\n $limit = 20;\n}\n\nif ($limit &gt; 50) {\n $limit = 50;\n}\n\nif ($limit == 0) {\n $limit = 1;\n}\n\n$text = \"最近 $limit 個使用者上線記錄 |圖片更新時間：$dateTime ||\";\n\n$url = \"https://script.google.com/macros/s/AKfycbxejz2Zqgt1VyWM-0jWXdi8fIj9Nff4fLEjSj8FDS-CBG9Bu5bE/exec?lastSeen=$limit\";\n$data = file_get_contents($url);\n$users = json_decode($data);\n\n$text .= \" UID \\| 暱稱 \" . str_repeat(\" \", 32) . \"\\| 時間 |\";\n$text .= str_repeat(\"-\", 60) . \"|\";\n\nforeach ($users-&gt;data as $user) {\n $id = $user-&gt;id;\n $name = $user-&gt;username;\n if ($user-&gt;time != \"X\") {\n $temp = $user-&gt;time;\n $timeStr = \"\";\n $temp = $now - $temp;\n\n if ($temp &gt; 60) {\n $min = intdiv($temp, 60);\n $timeStr .= \"{$min} 分 \";\n $temp = $temp % 60;\n }\n\n $timeStr .= \"{$temp} 秒前\";\n\n $time = 0;\n } else {\n $timeStr = \"X\";\n }\n\n if ($id &gt; 1000) {\n $space = \" \";\n } elseif ($id &gt; 100) {\n $space = \" \";\n } elseif ($id &gt; 10) {\n $space = \" \";\n } else {\n $space = \" \";\n }\n\n $len = strlen($name);\n $mblen = mb_strlen($name);\n $full = ($len - $mblen) / 2;\n $half = $mblen - $full;\n\n $width = 2 * $full + $half;\n $repeat = 36 - $width;\n if ($repeat &lt; 0) {\n $repeat = 0;\n }\n\n @$space2 = str_repeat(\" \", $repeat + 1);\n\n $text .= \"{$id}{$space}\\| {$name}{$space2}\\| {$timeStr}|\";\n}</code></pre>\n<script>\n if(\"undefined\"!==typeof hljs)hljs._ha();else if(\"undefined\"===typeof hljsLoading){hljsLoading=1;var a=document.getElementsByTagName(\"head\")[0],e=document.createElement(\"link\");e.type=\"text/css\";e.rel=\"stylesheet\";e.href=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css\";a.appendChild(e);e=document.createElement(\"script\");e.type=\"text/javascript\";e.onload=function(){var d={},f=0;hljs._hb=function(b){b.removeAttribute(\"data-hljs\");var c=b.innerHTML;c in d?b.innerHTML=d[c]:(7<++f&&(d={},f=0),hljs.highlightBlock(b.firstChild),d[c]=b.innerHTML)};hljs._ha=function(){for(var b=document.querySelectorAll(\"pre[data-hljs]\"),c=b.length;0<c;)hljs._hb(b.item(--c))};hljs._ha()};e.async=!0;e.src=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js\";a.appendChild(e)}\n </script>\n<p>\n<strong>\n .htaccess\n </strong>\n</p>\n<pre data-hljs=\"\"><code class=\"language-apache\">RewriteEngine On\nRewriteBase /kater/\n\nRewriteRule ^lastSeen(\\d+)\\.png$ lastSeen.php?limit=$1 [L]</code></pre>\n<script>\n if(\"undefined\"!==typeof hljs)hljs._ha();else if(\"undefined\"===typeof hljsLoading){hljsLoading=1;var a=document.getElementsByTagName(\"head\")[0],e=document.createElement(\"link\");e.type=\"text/css\";e.rel=\"stylesheet\";e.href=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css\";a.appendChild(e);e=document.createElement(\"script\");e.type=\"text/javascript\";e.onload=function(){var d={},f=0;hljs._hb=function(b){b.removeAttribute(\"data-hljs\");var c=b.innerHTML;c in d?b.innerHTML=d[c]:(7<++f&&(d={},f=0),hljs.highlightBlock(b.firstChild),d[c]=b.innerHTML)};hljs._ha=function(){for(var b=document.querySelectorAll(\"pre[data-hljs]\"),c=b.length;0<c;)hljs._hb(b.item(--c))};hljs._ha()};e.async=!0;e.src=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js\";a.appendChild(e)}\n </script>\n"}, {"author": "陳米家", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698260\" href=\"https://kater.me/d/63779/1\">\n 500 Internal Server Error\n </a>\n 很猛欸這個，你484異音同學ㄚ\n </p>\n"}, {"author": "陳米家", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698260\" href=\"https://kater.me/d/63779/1\">\n 500 Internal Server Error\n </a>\n 阿這個只會顯示有開上線紀錄的還是不管是誰都會顯示阿？\n </p>\n"}, {"author": "500 Internal Server Error", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698265\" href=\"https://kater.me/d/63779/3\">\n 陳米家\n </a>\n 84\n </p>\n<p>\n<a class=\"PostMention\" data-id=\"698266\" href=\"https://kater.me/d/63779/4\">\n 陳米家\n </a>\n 所有人\n </p>\n"}, {"author": "឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌", "body": "\n<p>\n 害我不能潛水的罪魁禍首\n </p>\n"}, {"author": "500 Internal Server Error", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698267\" href=\"https://kater.me/d/63779/5\">\n ឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌\n </a>\n 就是你的名字讓我發現零寬字元會大崩壞啦\n </p>\n"}, {"author": "឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698269\" href=\"https://kater.me/d/63779/7\">\n 500 Internal Server Error\n </a>\n 欸嘿嘿嘿嘿\n </p>\n"}, {"author": "Fong", "body": "\n<p>\n 我被抓到了\n <br/>\n 怕\n </p>\n"}, {"author": "申訳無院", "body": "\n<p>\n<s>\n 以後要潛水只好先登出了\n </s>\n<br/>\n 話說回來，像這樣能看到關閉上線狀態的使用者最近上線應該可以算是網站的缺陷了\n </p>\n"}, {"author": "500 Internal Server Error", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698278\" href=\"https://kater.me/d/63779/10\">\n 申訳無院\n </a>\n<br/>\n 原製作團隊估計也沒料到吧？\n <br/>\n 畢竟這個問題很不明顯。\n </p>\n<p>\n 只不過這個理論上能大致取得任何人的最後上線時間（打 x 的就抓大概這樣）\n <br/>\n 雖然實際做的話會有點像在攻擊伺服器就是了\n <br/>\n 但依然是個小缺陷\n </p>\n<p>\n 不過我們有紅色扳手\n <br/>\n 我覺得沒問題 😃\n </p>\n"}, {"author": "戰讚顫", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698278\" href=\"https://kater.me/d/63779/10\">\n 申訳無院\n </a>\n<br/>\n 用無痕視窗就不用登出惹(≧▽≦)\n </p>\n"}, {"author": "白稿紙", "body": "\n<p>\n 爹，娘\n <br/>\n 我上電視了\n </p>\n"}, {"author": "蔡陰魂還錢", "body": "\n<p>\n 為什麼會有uid0的ㄚ\n </p>\n"}, {"author": "500 Internal Server Error", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698312\" href=\"https://kater.me/d/63779/13\">\n 蔡陰魂還錢\n </a>\n 那個是更新圖片的帳號。為了保持筆數不變只好留著它，但它不是重點所以沉底，然後 uid 跟暱稱都是假的\n </p>\n"}, {"author": "可惡想成為大佬", "body": "\n<p>\n 好可怕ㄛ\n <br/>\n 被監控ㄌ\n </p>\n"}, {"author": "DOU5、希臘問號", "body": "\n<p>\n 我怎麼覺得我明明沒有一直在線\n <br/>\n 但是每張上面都有我\n </p>\n"}, {"author": "឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698394\" href=\"https://kater.me/d/63779/16\">\n DOU5、希臘問號\n </a>\n 因為你去看的時候你就送資料給卡特了\n <br/>\n 所以你就上線了\n </p>\n"}, {"author": "🐲🐱‍🚀🦃🎃🥙🌮🥐🥟我不是_ＭＡＮＯ教主🐲🐱‍🚀🦃🎃🥙🌮🥐🥟", "body": "\n<p>\n 有我 怕\n </p>\n"}, {"author": "DOU5、希臘問號", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698400\" href=\"https://kater.me/d/63779/18\">\n ឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌\n </a>\n<br/>\n 我是說別人po的\n </p>\n"}, {"author": "500 Internal Server Error", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698400\" href=\"https://kater.me/d/63779/18\">\n ឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌\n </a>\n 慢著，這句話有意圖使人誤會的嫌疑。\n </p>\n<p>\n 準確來說是進入這篇文章時送請求給卡特，卡特更新你的最後觀看時間（上線時間），然後我的伺服器跟卡特請求才產生圖片。\n </p>\n<p>\n 絕對不是我拿你的資訊直接送給卡特。\n <br/>\n （因為根本拿不到）\n </p>\n"}, {"author": "឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698401\" href=\"https://kater.me/d/63779/19\">\n DOU5、希臘問號\n </a>\n 因為那張圖是用網址即時產生的\n </p>\n"}, {"author": "DOU5、希臘問號", "body": "\n<p>\n<a class=\"PostMention\" data-id=\"698404\" href=\"https://kater.me/d/63779/20\">\n ឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌឴᠌᠌\n </a>\n<br/>\n 喔我現在才知道那個會即時更新\n <br/>\n 好潮ㄛ\n </p>\n"}]}