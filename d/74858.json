{"cacheTime": 1595529227, "baseUrl": "https://kater.me/d/74858", "title": "稍早寫的使用者排行榜的一些心得與交流", "content": [{"author": "天涯之外", "body": "\n<p>\n 跪求各位技術嫺熟的大佬看到這篇文鞭小力一點，我知道我很菜。\n </p>\n<hr/>\n<p>\n 在說正題之前，我認爲進階使用者在用 Google 試算表時都應該要會這個名字長到靠北的功能：\n </p>\n<div style=\"text-align:center\">\n<p>\n<strong>\n Google Visualization API Query Language\n </strong>\n</p>\n</div>\n<hr/>\n<h4>\n 爲什麼做？\n </h4>\n<ol style=\"list-style-type:decimal\">\n<li>\n 用以紀念我的第 500 篇討論與第 10000 篇貼文\n </li>\n<li>\n 小月之前做的那個估計是用各種 lookup 函式兜成的，因此會有重複資料的問題\n <br/>\n （當有多名使用者都有一樣數值時就會發生）（小月…）\n <br/>\n 然後，只限定前 10 名也讓我常常很好奇底下是什麼狀況（總之就是我龜毛）\n </li>\n<li>\n 找個理由讓自己練習。（在這篇之前，我完全沒碰過 SVG）\n </li>\n</ol>\n<h4>\n 使用語言\n </h4>\n<ol style=\"list-style-type:decimal\">\n<li>\n JavaScript\n <br/>\n （對，就只有這個。雖然玩 SVG 應該要順便玩後端，但我後來沒有這麼做）\n </li>\n</ol>\n<h4>\n 使用服務\n </h4>\n<ol style=\"list-style-type:decimal\">\n<li>\n GitHub Pages\n </li>\n<li>\n Google Apps Script\n </li>\n</ol>\n<h4>\n 原始碼\n </h4>\n<p>\n 我知道我肯定有很多地方寫得不好，敬請指教。\n </p>\n<ol style=\"list-style-type:decimal\">\n<li>\n<p>\n 網頁部分直接丟在 GitHub 上了，以前都寫在 GAS 裡面根本綁手綁腳（之後有空都會移過來）：\n <br/>\n<a href=\"https://github.com/LianSheng197/kater-misc/tree/master/rank\" rel=\"nofollow noreferrer\" target=\"_blank\">\n kater-misc/rank\n </a>\n</p>\n</li>\n<li>\n<p>\n 充當後台的 GAS 部分核心原始碼：\n </p>\n<pre data-hljs=\"\"><code class=\"language-js\">function doGet(e) {\n if(e.parameter.rankSortBy != undefined &amp;&amp; e.parameter.rankLimit != undefined &amp;&amp; e.parameter.rankOffset != undefined) {\n let sortField = [\"points\", \"changeNameCount\", \"discussions\", \"posts\", \"rate\"];\n\n // points, changeNameCount, discussions, posts, rate. 無前綴遞增、前綴負號遞減\n let _sortby = e.parameter.rankSortBy; \n let _limit = e.parameter.rankLimit;\n let _offset = e.parameter.rankOffset;\n let _condition = e.parameter.rankCondition == undefined ? \"\" : e.parameter.rankCondition; \n \n if(sortField.includes(_sortby.replace(\"-\", \"\"))){\n let result = getUserRank(_sortby, _limit, _offset, _condition);\n return ContentService.createTextOutput(result);\n } else {\n return ContentService.createTextOutput(\"參數 rankSortBy 錯誤！沒有 \" + _sortby + \" 這個選項！\\n目前可用選項：\" + JSON.stringify(sortField));\n }\n }\n}\n\n/**\n * _sortby = 可能值：[\"points\", \"changeNameCount\", \"discussions\", \"posts\", \"rate\"]\n * _limit = 零或正整數\n * _offset = 零或正整數\n * _condition = 空字串 \"\" 或是 SQL 條件句 \"WHERE ...\"，其中欄位已在前端頁面替換完畢。\n * 例如： \"WHERE G &gt;= 10 AND H &gt;= 50\"\n */\nfunction getUserRank(_sortby, _limit, _offset, _condition) {\n let SpreadSheet = SpreadsheetApp.openByUrl(url); \n let SheetName = SpreadSheet.getSheetByName(\"users\");\n let lastRow = SheetName.getLastRow();\n \n const FIELD = {\n uid: \"A\",\n username: \"B\",\n points: \"C\",\n changeNameCount: \"F\",\n discussions: \"G\",\n posts: \"H\",\n avatarUrl: \"I\",\n rate: \"(C/H)\"\n };\n \n let orderType = _sortby.match(\"-\") != null ? \"DESC\" : \"ASC\";\n let orderColumn = FIELD[_sortby.replace(\"-\", \"\")];\n \n let query = \"=QUERY(users!A1:I\" + lastRow + \", \\\"SELECT A,B,C,F,G,H,I,(C/H) \" + _condition + \" ORDER BY \" + orderColumn + \" \" + orderType + \" LIMIT \" + _limit + \" OFFSET \" + _offset + \"\\\", 1)\";\n \n let sheet = SpreadSheet.insertSheet();\n let r = sheet.getRange(1, 1).setFormula(query);\n\n let reply = sheet.getDataRange().getValues();\n SpreadSheet.deleteSheet(sheet);\n\n return reply;\n}</code></pre>\n<script>\n if(\"undefined\"!==typeof hljs)hljs._ha();else if(\"undefined\"===typeof hljsLoading){hljsLoading=1;var a=document.getElementsByTagName(\"head\")[0],e=document.createElement(\"link\");e.type=\"text/css\";e.rel=\"stylesheet\";e.href=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css\";a.appendChild(e);e=document.createElement(\"script\");e.type=\"text/javascript\";e.onload=function(){var d={},f=0;hljs._hb=function(b){b.removeAttribute(\"data-hljs\");var c=b.innerHTML;c in d?b.innerHTML=d[c]:(7<++f&&(d={},f=0),hljs.highlightBlock(b.firstChild),d[c]=b.innerHTML)};hljs._ha=function(){for(var b=document.querySelectorAll(\"pre[data-hljs]\"),c=b.length;0<c;)hljs._hb(b.item(--c))};hljs._ha()};e.async=!0;e.src=\"//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js\";a.appendChild(e)}\n </script>\n<h4>\n 試算表原始資料格式\n </h4>\n<p>\n<a href=\"https://i.imgur.com/7trA3Xm.png\" rel=\"nofollow noreferrer\" target=\"_blank\">\n<img alt=\"\" src=\"https://i.imgur.com/7trA3Xm.png\" title=\"\"/>\n</a>\n</p>\n<h4>\n 特殊\n </h4>\n<p>\n 查詢資料採用開頭說的\n <strong>\n Google Visualization API Query Language\n </strong>\n<br/>\n 稍微有一點 SQL 底子的人就能快速上手，真的很方便\n </p>\n<h4>\n 查詢資料實例\n </h4>\n<p>\n<a href=\"https://i.imgur.com/gosaQ6V.png\" rel=\"nofollow noreferrer\" target=\"_blank\">\n<img alt=\"\" src=\"https://i.imgur.com/gosaQ6Vh.png\" title=\"\"/>\n</a>\n</p>\n<hr/>\n<p>\n 原先做 SVG 的目的是爲了方便匯出成圖片，因此引用了鼎鼎大名的套件\n <strong>\n canvg\n </strong>\n<br/>\n 無奈後來一直遇到 CORS 錯誤，即便祭出了萬用解法 img.crossOrigin = “anonymous” 依然無法解決\n <br/>\n 根據 Google 經驗，這樣有三個可能解法：\n </p>\n<ol style=\"list-style-type:decimal\">\n<li>\n 使用\n <a href=\"https://cors-anywhere.herokuapp.com/\" rel=\"nofollow noreferrer\" target=\"_blank\">\n cors-anywhere\n </a>\n<br/>\n （這太慢了，而且總覺得這樣做的話有點濫用？不知道怎麼說，反正我覺得不行）\n </li>\n<li>\n 自幹一個 cors 服務\n <br/>\n （聽說 GAS 就可以做了…？ 但是實在沒多餘時間精力去研究）\n </li>\n<li>\n 每天備份資料時就順便把使用者的頭貼存下來到雲端\n <br/>\n （這樣又要燒腦想怎麽管理檔案以便快速更新與使用… 以前研究過，曾經差點把自己雲端空間塞爆，因爲忽略了 Google 雲端空間存檔是依據 ID 而非檔名這一事實）\n </li>\n</ol>\n<br/>\n<p>\n 不曉得除了上述三個可能外，還有其他解法嗎？\n </p>\n</li>\n</ol>\n"}]}